{% for account in accounts %}
  {% set isWritableString = 'true' if account.isWritable else 'false' %}
  // {{ account.titleCaseName }}{% if account.isOptional %} (optional){% endif %}.
  {% if account.hasDefaultValue %}
      {% if account.defaultsTo.kind === 'program' %}
        keys.push({
          pubkey: {{ accountsObj }}.{{ account.name }} ?? getProgramAddressWithFallback(context, '{{ account.defaultsTo.program.name }}', '{{ account.defaultsTo.program.address }}'),
          isSigner: false,
          isWritable: {{ isWritableString }},
        });
      {% elif account.defaultsTo.kind === 'address' %}
        keys.push({
          pubkey: {{ accountsObj }}.{{ account.name }} ?? context.eddsa.createPublicKey('{{ account.defaultsTo.address }}'),
          isSigner: false,
          isWritable: {{ isWritableString }},
        });
      {% else %}
        keys.push({
          pubkey: {{ accountsObj }}.{{ account.name }} ?? programId,
          isSigner: false,
          isWritable: {{ isWritableString }},
        });
      {% endif %}
  {% else %}
    {% if account.isOptional %}
    if ({{ accountsObj }}.{{ account.name }}) {
    {% endif %}
      {% if account.isOptionalSigner %}
        if (isSigner({{ accountsObj }}.{{ account.name }})) {
          signers.push({{ accountsObj }}.{{ account.name }});
          keys.push({
            pubkey: {{ accountsObj }}.{{ account.name }}.publicKey,
            isSigner: true,
            isWritable: {{ isWritableString }},
          });
        } else {
          keys.push({
            pubkey: {{ accountsObj }}.{{ account.name }},
            isSigner: false,
            isWritable: {{ isWritableString }},
          });
        }
      {% elif account.isSigner  %}
        signers.push({{ accountsObj }}.{{ account.name }});
        keys.push({ pubkey: {{ accountsObj }}.{{ account.name }}.publicKey, isSigner: true, isWritable: {{ isWritableString }} });
      {% else %}
        keys.push({ pubkey: {{ accountsObj }}.{{ account.name }}, isSigner: false, isWritable: {{ isWritableString }} });
      {% endif %}
    {% if account.isOptional %}
    }
    {% endif %}
  {% endif %}

{% endfor %}